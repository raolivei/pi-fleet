apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "pi-hole.fullname" . }}-dnsmasq
  labels:
    {{- include "pi-hole.labels" . | nindent 4 }}
data:
  05-custom-dns.conf: |
    # Custom DNS rewrites moved to BIND backend for RFC2136 support
    # Only put non-dynamic records here if needed
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "pi-hole.fullname" . }}-bind
  labels:
    {{- include "pi-hole.labels" . | nindent 4 }}
data:
  named.conf: |
    // BIND configuration for RFC2136 dynamic DNS updates
    options {
      directory "/var/named";
      listen-on port 5353 { any; };
      allow-query { any; };
      allow-transfer { none; };
      allow-update { key "externaldns-key"; };
      recursion yes;
      forwarders {
        10.43.0.10;  // CoreDNS
      };
      forward first;
      dnssec-validation no;
    };

    // TSIG key for external-dns (injected by bind-init from Vault secret)
    key "externaldns-key" {
      algorithm hmac-sha256;
      secret "TSIG_SECRET_PLACEHOLDER";
    };

    // Zone for eldertree.local
    zone "eldertree.local" IN {
      type master;
      file "eldertree.local.zone";
      allow-update { key "externaldns-key"; };
    };

  eldertree.local.zone: |
    $TTL 300
    $ORIGIN eldertree.local.
    @       IN      SOA     ns1.eldertree.local. admin.eldertree.local. (
                            2024111301  ; serial
                            3600        ; refresh
                            1800        ; retry
                            604800      ; expire
                            300         ; minimum
                            )
            IN      NS      ns1.eldertree.local.
    ns1     IN      A       {{ .Values.config.clusterIP }}

  # dnsmasq configuration to forward eldertree.local queries to BIND
  06-bind-backend.conf: |
    # Forward eldertree.local queries to BIND for RFC2136-managed records
    server=/eldertree.local/127.0.0.1#5353
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "pi-hole.fullname" . }}-upstream
  labels:
    {{- include "pi-hole.labels" . | nindent 4 }}
data:
  99-upstream-dns.conf: |
    # Upstream DNS servers configured via ConfigMap
    # Use Google DNS directly (port 53 is reachable)
    server={{ .Values.config.dns1 }}
    server=8.8.4.4
    server={{ .Values.config.dns2 }}



---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: api-path-rewrite
  namespace: swimto
spec:
  replacePathRegex:
    regex: "^/api(/.*?)/?$"
    replacement: "$1/"
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: redirect-https
  namespace: swimto
spec:
  redirectScheme:
    scheme: https
    permanent: true
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: swimto-api
  namespace: swimto
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
    traefik.ingress.kubernetes.io/router.middlewares: swimto-redirect-https@kubernetescrd,swimto-api-path-rewrite@kubernetescrd
    cert-manager.io/cluster-issuer: selfsigned-cluster-issuer
  labels:
    app: swimto
spec:
  ingressClassName: traefik
  tls:
    - hosts:
        - swimto.eldertree.local
      secretName: swimto-tls
  rules:
    - host: swimto.eldertree.local
      http:
        paths:
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: swimto-api-service
                port:
                  number: 8000
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: swimto-web
  namespace: swimto
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
    traefik.ingress.kubernetes.io/router.middlewares: swimto-redirect-https@kubernetescrd
    cert-manager.io/cluster-issuer: selfsigned-cluster-issuer
  labels:
    app: swimto
spec:
  ingressClassName: traefik
  tls:
    - hosts:
        - swimto.eldertree.local
      secretName: swimto-tls
  rules:
    - host: swimto.eldertree.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: swimto-web-service
                port:
                  number: 3000
---
# Public domain Ingress with Cloudflare Origin Certificate (for mobile location services)
# Configured for swimto.eldertree.xyz
# Requires:
# 1. Cloudflare Origin Certificate generated in Cloudflare Dashboard
# 2. Certificate stored as Kubernetes secret: swimto-cloudflare-origin-tls
# 3. Cloudflare SSL/TLS mode set to "Full (strict)" in Cloudflare Dashboard
# 4. DNS record managed by External-DNS (automatic via annotation)
# 5. Cloudflare proxy enabled (orange cloud) for automatic HTTPS
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: swimto-api-public
  namespace: swimto
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
    traefik.ingress.kubernetes.io/router.middlewares: swimto-api-path-rewrite@kubernetescrd
    external-dns.alpha.kubernetes.io/hostname: swimto.eldertree.xyz
  labels:
    app: swimto
spec:
  ingressClassName: traefik
  tls:
    - hosts:
        - swimto.eldertree.xyz
      secretName: swimto-cloudflare-origin-tls
  rules:
    - host: swimto.eldertree.xyz
      http:
        paths:
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: swimto-api-service
                port:
                  number: 8000
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: swimto-web-public
  namespace: swimto
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
    external-dns.alpha.kubernetes.io/hostname: swimto.eldertree.xyz
  labels:
    app: swimto
spec:
  ingressClassName: traefik
  tls:
    - hosts:
        - swimto.eldertree.xyz
      secretName: swimto-cloudflare-origin-tls
  rules:
    - host: swimto.eldertree.xyz
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: swimto-web-service
                port:
                  number: 3000
---
# IP-based Ingress for access via IP (mobile/iPhone via WireGuard, or localhost)
# Supports both HTTP and HTTPS
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: swimto-api-ip
  namespace: swimto
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
    traefik.ingress.kubernetes.io/router.middlewares: swimto-api-path-rewrite@kubernetescrd
    traefik.ingress.kubernetes.io/router.priority: "10"
  labels:
    app: swimto
spec:
  ingressClassName: traefik
  rules:
    - http:
        paths:
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: swimto-api-service
                port:
                  number: 8000
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: swimto-web-ip
  namespace: swimto
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
    traefik.ingress.kubernetes.io/router.priority: "10"
  labels:
    app: swimto
spec:
  ingressClassName: traefik
  rules:
    - http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: swimto-web-service
                port:
                  number: 3000

apiVersion: v1
kind: ConfigMap
metadata:
  name: wireguard-install-script
  namespace: wireguard-vpn
data:
  install-wireguard.sh: |
    #!/bin/bash
    set -e

    # WireGuard VPN Server Installation Script for Raspberry Pi
    # This script installs and configures WireGuard on the Raspberry Pi host

    echo "ğŸ” WireGuard VPN Server Installation"
    echo "===================================="

    # Check if running as root
    if [ "$EUID" -ne 0 ]; then 
      echo "âŒ Please run as root (use sudo)"
      exit 1
    fi

    # Detect OS
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS=$ID
    else
        echo "âŒ Cannot detect OS"
        exit 1
    fi

    echo "ğŸ“¦ Installing WireGuard..."

    # Install WireGuard based on OS
    if [ "$OS" = "debian" ] || [ "$OS" = "ubuntu" ] || [ "$OS" = "raspbian" ]; then
        apt-get update
        apt-get install -y wireguard wireguard-tools iptables qrencode
        
        # Enable IP forwarding
        echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
        echo "net.ipv6.conf.all.forwarding=1" >> /etc/sysctl.conf
        sysctl -p
        
    elif [ "$OS" = "fedora" ] || [ "$OS" = "rhel" ] || [ "$OS" = "centos" ]; then
        dnf install -y wireguard-tools iptables qrencode
        echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
        sysctl -p
    else
        echo "âŒ Unsupported OS: $OS"
        exit 1
    fi

    echo "âœ… WireGuard installed"

    # Create WireGuard directory
    mkdir -p /etc/wireguard
    cd /etc/wireguard

    # Generate keys if they don't exist
    if [ ! -f /etc/wireguard/private.key ]; then
        echo "ğŸ”‘ Generating WireGuard keys..."
        wg genkey | tee private.key | wg pubkey > public.key
        chmod 600 private.key
        chmod 644 public.key
    fi

    # Read keys
    PRIVATE_KEY=$(cat /etc/wireguard/private.key)
    PUBLIC_KEY=$(cat /etc/wireguard/public.key)

    echo "ğŸ“ Public Key: $PUBLIC_KEY"

    # Get server IP (first non-loopback IP)
    SERVER_IP=$(ip -4 addr show | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | grep -v '127.0.0.1' | head -1)
    SERVER_PORT=51820

    echo "ğŸŒ Server IP: $SERVER_IP"
    echo "ğŸ”Œ Server Port: $SERVER_PORT"

    # Create WireGuard config
    cat > /etc/wireguard/wg0.conf <<EOF
    [Interface]
    Address = 10.8.0.1/24
    ListenPort = $SERVER_PORT
    PrivateKey = $PRIVATE_KEY
    PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -A FORWARD -o wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
    PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -D FORWARD -o wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE

    EOF

    # Enable and start WireGuard
    systemctl enable wg-quick@wg0
    systemctl start wg-quick@wg0

    echo "âœ… WireGuard configured and started"
    echo "ğŸ“‹ Server Public Key: $PUBLIC_KEY"
    echo "ğŸ’¡ Use this key to configure clients"


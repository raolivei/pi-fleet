---
- name: Fix Emergency Mode and Root Lock
  hosts: raspberry_pi
  become: true
  vars:
    target_password: "{{ vault_target_password | default(lookup('env', 'PI_PASSWORD')) }}"
    password_hash: "{{ target_password | password_hash('sha512') }}"

  tasks:
    - name: Unlock root account
      command: passwd -u root
      changed_when: false
      failed_when: false

    - name: Set root password
      user:
        name: root
        password: "{{ password_hash }}"
        update_password: always
      failed_when: false

    - name: Reset root account lockout
      command: faillock --user root --reset
      changed_when: false
      failed_when: false

    - name: Check current fstab
      slurp:
        src: /etc/fstab
      register: fstab_content
      changed_when: false

    - name: Display fstab entries that might cause issues
      debug:
        msg: "Checking fstab for problematic mounts..."
      when: fstab_content.content is defined

    - name: Add nofail to backup mount if missing
      replace:
        path: /etc/fstab
        regexp: '^(/dev/sdb1[^\s]+)\s+([^\s]+)\s+(ext4)\s+([^,\s]+)(.*?)(\s+\d+\s+\d+)$'
        replace: '\1 \2 \3 \4,nofail\5\6'
        backup: yes
      failed_when: false

    - name: Add nofail to NVMe mount if missing
      replace:
        path: /etc/fstab
        regexp: '^(/dev/nvme[^\s]+)\s+([^\s]+)\s+(ext4)\s+([^,\s]+)(.*?)(\s+\d+\s+\d+)$'
        replace: '\1 \2 \3 \4,nofail\5\6'
        backup: yes
      failed_when: false

    - name: Verify root account status
      command: passwd -S root
      register: root_status
      changed_when: false

    - name: Display root account status
      debug:
        msg: "Root account status: {{ root_status.stdout }}"

    - name: Display completion message
      debug:
        msg:
          - "âœ… Emergency mode fixes applied!"
          - ""
          - "Changes made:"
          - "  - Root account unlocked"
          - "  - Root password set"
          - "  - Added nofail to optional mounts in fstab"
          - ""
          - "Next steps:"
          - "  1. Reboot: sudo reboot"
          - "  2. System should boot normally (not emergency mode)"
          - "  3. If still in emergency mode, check: systemctl status"

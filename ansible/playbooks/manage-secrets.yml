---
- name: Manage Secrets in Vault
  hosts: localhost
  connection: local
  vars:
    kubeconfig_path: "{{ kubeconfig_path | default('~/.kube/config-eldertree') }}"
    vault_namespace: "{{ vault_namespace | default('vault') }}"
    secrets: []
    # Example secrets structure:
    # secrets:
    #   - path: "secret/terraform/cloudflare-api-token"
    #     data:
    #       api-token: "your-token-here"
    #   - path: "secret/external-dns/cloudflare-api-token"
    #     data:
    #       api-token: "your-token-here"

  tasks:
    - name: Expand kubeconfig path
      set_fact:
        kubeconfig_expanded: "{{ kubeconfig_path | expanduser }}"

    - name: Check if kubeconfig exists
      stat:
        path: "{{ kubeconfig_expanded }}"
      register: kubeconfig_stat
      failed_when: false

    - name: Fail if kubeconfig does not exist
      fail:
        msg: "Kubeconfig not found at {{ kubeconfig_expanded }}. Please configure kubectl first."
      when: not kubeconfig_stat.stat.exists

    - name: Get Vault pod
      command: >
        kubectl get pods -n {{ vault_namespace }}
        -l app.kubernetes.io/name=vault
        -o jsonpath='{.items[0].metadata.name}'
      environment:
        KUBECONFIG: "{{ kubeconfig_expanded }}"
      register: vault_pod_result
      changed_when: false
      failed_when: false

    - name: Fail if Vault pod not found
      fail:
        msg: "Vault pod not found in namespace {{ vault_namespace }}. Make sure Vault is deployed and running."
      when: vault_pod_result.stdout == ""

    - name: Set Vault pod name
      set_fact:
        vault_pod: "{{ vault_pod_result.stdout }}"

    - name: Check if Vault is unsealed
      command: >
        kubectl exec -n {{ vault_namespace }} {{ vault_pod }}
        -- vault status
      environment:
        KUBECONFIG: "{{ kubeconfig_expanded }}"
      register: vault_status_result
      changed_when: false
      failed_when: false

    - name: Parse Vault sealed status
      set_fact:
        vault_sealed: "{{ 'true' if 'Sealed' in vault_status_result.stdout and 'true' in vault_status_result.stdout else 'false' }}"
      when: vault_status_result.rc == 0

    - name: Fail if Vault is sealed
      fail:
        msg: "Vault is sealed. Please unseal it first using: ./scripts/operations/unseal-vault.sh"
      when: vault_sealed == "true"

    - name: Store secrets in Vault
      block:
        - name: Build vault kv put command for secret
          set_fact:
            vault_kv_data: "{{ vault_kv_data | default({}) | combine({item.key: item.value}) }}"
          loop: "{{ item.data | dict2items }}"
          loop_control:
            label: "{{ item.key }}"

        - name: Store secret in Vault
          command: >
            kubectl exec -n {{ vault_namespace }} {{ vault_pod }}
            -- vault kv put {{ item.path }}
            {{ vault_kv_data | dict2items | map('join', '=') | map('regex_replace', '^(.*)$', "'\\1'") | join(' ') }}
          environment:
            KUBECONFIG: "{{ kubeconfig_expanded }}"
          register: vault_store_result
          vars:
            vault_kv_data: "{{ item.data }}"
          loop: "{{ secrets }}"
          loop_control:
            label: "{{ item.path }}"

        - name: Display stored secrets
          debug:
            msg:
              - "âœ… Secrets stored successfully:"
              - "{{ item.item.path }}"
          loop: "{{ vault_store_result.results }}"
          when: item.rc == 0
      when: secrets | length > 0

    - name: Display usage instructions
      debug:
        msg:
          - "=== Secret Management ==="
          - ""
          - "To store secrets, use the secrets variable:"
          - ""
          - "ansible-playbook playbooks/manage-secrets.yml \\"
          - "  -e 'secrets=["
          - "    {path: \"secret/terraform/cloudflare-api-token\", data: {api-token: \"YOUR_TOKEN\"}},"
          - "    {path: \"secret/external-dns/cloudflare-api-token\", data: {api-token: \"YOUR_TOKEN\"}}"
          - "  ]'"
          - ""
          - "Or use the convenience script:"
          - "  ./scripts/secrets/store-cloudflare-token.sh YOUR_TOKEN"
      when: secrets | length == 0



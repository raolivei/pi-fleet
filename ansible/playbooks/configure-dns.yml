---
- name: Configure DNS for Eldertree Cluster
  hosts: localhost
  connection: local
  vars:
    # Node IPs (WiFi network - management)
    node_1_ip: "{{ node_1_ip | default('192.168.2.101') }}"
    node_2_ip: "{{ node_2_ip | default('192.168.2.102') }}"
    node_3_ip: "{{ node_3_ip | default('192.168.2.103') }}"
    # kube-vip VIP for HA API server
    kube_vip_ip: "{{ kube_vip_ip | default('192.168.2.100') }}"
    # Pi-hole LoadBalancer IP
    pihole_dns_ip: "{{ pihole_dns_ip | default('192.168.2.201') }}"
    configure_hosts_file: "{{ configure_hosts_file | default(true) }}"
    services:
      - "node-1.eldertree.local"
      - "node-2.eldertree.local"
      - "node-3.eldertree.local"
      - "canopy.eldertree.local"
      - "grafana.eldertree.local"
      - "prometheus.eldertree.local"
      - "vault.eldertree.local"
      - "pihole.eldertree.local"
      - "swimto.eldertree.local"

  tasks:
    - name: Display DNS configuration options
      debug:
        msg:
          - "=== DNS Configuration for Eldertree Cluster ==="
          - ""
          - "Cluster IP: {{ eldertree_ip }}"
          - ""
          - "Option 1: Router DNS (Recommended - Network-wide)"
          - "  Set router DNS to: {{ pihole_dns_ip }} (Pi-hole LoadBalancer IP)"
          - "  This enables ad-blocking and eldertree.local DNS resolution network-wide"
          - ""
          - "Option 2: macOS System Settings"
          - "  System Settings → Network → DNS → Add: {{ pihole_dns_ip }}"
          - "  Secondary DNS: 8.8.8.8 (Google DNS) or 1.1.1.1 (Cloudflare DNS)"
          - ""
          - "Option 3: /etc/hosts (Fallback)"
          - "  Set configure_hosts_file=true to add entries automatically"

    - name: Check if /etc/hosts configuration is requested
      debug:
        msg: "Skipping /etc/hosts configuration (set configure_hosts_file=true to enable)"
      when: not configure_hosts_file

    - name: Configure /etc/hosts entries
      block:
        - name: Check current /etc/hosts content
          slurp:
            src: /etc/hosts
          register: hosts_content
          become: true
          become_user: root
          changed_when: false
          failed_when: false

        - name: Add node DNS entries to /etc/hosts
          lineinfile:
            path: /etc/hosts
            regexp: "^{{ item.ip }}\\s+{{ item.hostname }}"
            line: "{{ item.ip }}  {{ item.hostname }}"
            state: present
            backup: true
          become: true
          become_user: root
          loop:
            - { hostname: "node-1.eldertree.local node-1", ip: "{{ node_1_ip }}" }
            - { hostname: "node-2.eldertree.local node-2", ip: "{{ node_2_ip }}" }
            - { hostname: "node-3.eldertree.local node-3", ip: "{{ node_3_ip }}" }
            - { hostname: "eldertree.local eldertree", ip: "{{ kube_vip_ip }}" }
          register: node_hosts_updated

        - name: Add service DNS entries to /etc/hosts
          lineinfile:
            path: /etc/hosts
            regexp: "^{{ kube_vip_ip }}\\s+{{ item }}"
            line: "{{ kube_vip_ip }}  {{ item }}"
            state: present
            backup: true
          become: true
          become_user: root
          loop: "{{ services | reject('match', 'node-.*') | list }}"
          register: hosts_updated

        - name: Display updated entries
          debug:
            msg:
              - "✅ DNS entries added to /etc/hosts:"
              - "{{ item.item }}"
          loop: "{{ hosts_updated.results }}"
          when: item.changed

        - name: Display summary
          debug:
            msg:
              - "✅ DNS configuration complete"
              - ""
              - "Services accessible at:"
              - "  - https://canopy.eldertree.local"
              - "  - https://grafana.eldertree.local"
              - "  - https://prometheus.eldertree.local"
              - "  - https://vault.eldertree.local"
              - "  - https://pihole.eldertree.local"
              - "  - https://swimto.eldertree.local"
      when: configure_hosts_file


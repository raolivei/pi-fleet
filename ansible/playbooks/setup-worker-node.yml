---
# Master playbook for worker node setup
# This orchestrates complete setup for a new Raspberry Pi worker node
# Usage: ansible-playbook playbooks/setup-worker-node.yml --limit <hostname> -e hostname=<hostname> -e static_ip=<ip>

- name: System Configuration
  import_playbook: setup-system.yml
  vars:
    target_user: raolivei
    node_hostname: "{{ hostname_var | default(node_hostname | default('eldertree-node-1')) }}"
    node_ip: "{{ static_ip_var | default(node_ip | default('')) }}" # Empty for DHCP
    backup_device: "{{ backup_device_var | default('') }}"

- name: Setup Terminal Monitoring
  import_playbook: setup-terminal-monitoring.yml
  vars:
    target_user: raolivei

- name: Install k3s Worker
  import_playbook: install-k3s-worker.yml
  vars:
    k3s_url: "https://eldertree:6443"
    k3s_token: "{{ k3s_token | default('') }}" # Must be provided
    k3s_node_name: "{{ hostname | default('eldertree-node-1') }}"

- name: Setup Summary
  hosts: localhost
  connection: local
  tasks:
    - name: Display completion summary
      debug:
        msg:
          - "=== Worker Node Setup Complete ==="
          - ""
          - "Hostname: {{ hostname | default('eldertree-node-1') }}"
          - "System configuration: Complete"
          - "k3s worker installation: Complete"
          - ""
          - "Verify node joined cluster:"
          - "  kubectl get nodes --kubeconfig=~/.kube/config-eldertree"

---
- name: Configure raolivei user on Raspberry Pi
  hosts: raspberry_pi
  become: true
  vars:
    target_user: raolivei
    # Password should be set via Ansible Vault or environment variable
    # Use: ansible-playbook --ask-vault-pass or set env_target_password environment variable
    target_password: "{{ vault_target_password | default(lookup('env', 'env_target_password') | default('CHANGE_ME')) }}"
    # Generate password hash using SHA-512 (Linux default)
    # This will be generated at runtime using the password_hash filter
    password_hash: "{{ target_password | password_hash('sha512') }}"

  tasks:
    - name: Check if user {{ target_user }} exists
      getent:
        database: passwd
        key: "{{ target_user }}"
      register: user_check
      failed_when: false
      changed_when: false

    - name: Create user {{ target_user }}
      user:
        name: "{{ target_user }}"
        password: "{{ password_hash }}"
        shell: /bin/bash
        groups: sudo
        append: yes
        create_home: yes
        home: /home/{{ target_user }}
        state: present
      when: user_check.ansible_facts.getent_passwd[target_user] is not defined

    - name: Update password for existing user {{ target_user }}
      user:
        name: "{{ target_user }}"
        password: "{{ password_hash }}"
      when: user_check.ansible_facts.getent_passwd[target_user] is defined

    - name: Ensure user {{ target_user }} is in sudo group
      user:
        name: "{{ target_user }}"
        groups: sudo
        append: yes

    - name: Configure passwordless sudo for {{ target_user }}
      lineinfile:
        path: /etc/sudoers.d/{{ target_user }}
        line: "{{ target_user }} ALL=(ALL) NOPASSWD: ALL"
        create: yes
        validate: "visudo -cf %s"
        mode: "0440"
        owner: root
        group: root

    - name: Ensure home directory has correct permissions
      file:
        path: /home/{{ target_user }}
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: "0755"
        state: directory

    # =========================================================================
    # Configure btop terminal size detection (fixes SSH misalignment)
    # =========================================================================
    - name: Create bin directory for user scripts
      file:
        path: /home/{{ target_user }}/bin
        state: directory
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: "0755"

    - name: Ensure ~/bin is in PATH
      lineinfile:
        path: /home/{{ target_user }}/.bashrc
        regexp: '^export PATH=.*\$HOME/bin'
        line: 'export PATH="$HOME/bin:$PATH"'
        state: present
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        insertafter: '^# ~/.bashrc'

    - name: Create btop wrapper script to fix terminal size detection
      copy:
        dest: /home/{{ target_user }}/bin/btop
        content: |
          #!/bin/bash
          # btop wrapper script to ensure proper terminal size detection
          # Fixes misalignment issues when accessing via SSH
          
          # Detect terminal size and set environment variables
          if [ -t 0 ]; then
              # Get terminal size using stty
              if stty size >/dev/null 2>&1; then
                  TERM_SIZE=$(stty size)
                  LINES=$(echo $TERM_SIZE | awk '{print $1}')
                  COLUMNS=$(echo $TERM_SIZE | awk '{print $2}')
                  
                  # Export terminal dimensions
                  export LINES COLUMNS
                  
                  # Force terminal resize to ensure proper detection
                  stty rows $LINES cols $COLUMNS >/dev/null 2>&1
              else
                  # Fallback to tput if stty fails
                  if command -v tput >/dev/null 2>&1; then
                      export LINES=$(tput lines)
                      export COLUMNS=$(tput cols)
                  fi
              fi
              
              # If still not set, use defaults
              if [ -z "$LINES" ] || [ -z "$COLUMNS" ]; then
                  export LINES=${LINES:-24}
                  export COLUMNS=${COLUMNS:-80}
              fi
          fi
          
          # Launch btop with proper terminal context
          exec /usr/bin/btop "$@"
        mode: "0755"
        owner: "{{ target_user }}"
        group: "{{ target_user }}"

    - name: Display user configuration summary
      debug:
        msg:
          - "User {{ target_user }} has been configured"
          - "Password: [REDACTED]"
          - "Home directory: /home/{{ target_user }}"
          - "Sudo access: Enabled (passwordless)"
          - "btop wrapper: ~/bin/btop (fixes terminal size detection over SSH)"

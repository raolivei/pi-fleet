---
- name: Complete System Setup for Eldertree Raspberry Pi
  hosts: raspberry_pi
  become: true
  vars:
    target_user: raolivei
    # Password should be set via Ansible Vault or environment variable
    # Use: ansible-playbook --ask-vault-pass or set env_target_password environment variable
    target_password: "{{ vault_target_password | default(lookup('env', 'env_target_password') | default('CHANGE_ME')) }}"
    hostname: "{{ node_hostname | default(hostname | default('eldertree')) }}"
    # Network Configuration - DHCP by default (SAFER)
    # Router DHCP reservations are recommended - router assigns reserved IPs automatically
    # To configure static IP (NOT recommended if router has reservations), you MUST pass: -e "configure_static_ip=true" AND -e "static_ip=192.168.2.86"
    configure_static_ip_var: "{{ configure_static_ip | default(false) | bool }}" # MUST be explicitly set to true
    static_ip: "{{ node_ip | default(static_ip | default('')) }}" # Set to null/empty to use DHCP (default, recommended with router reservations)
    static_netmask: "{{ network_netmask | default('255.255.255.0') }}"
    static_gateway: "{{ network_gateway | default('192.168.2.1') }}"
    static_dns: "{{ network_dns | default(['192.168.2.1', '8.8.8.8']) }}"
    backup_device_var: "{{ backup_device | default('') }}"
    backup_mount_path: "{{ backup_mount | default(backup_mount_default | default('/mnt/backup')) }}"
    password_hash: "{{ target_password | password_hash('sha512') }}"

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install essential packages
      apt:
        name:
          - curl
          - wget
          - git
          - vim
          - htop
          - btop
          - iptables
          - ufw
          - bluez
          - bluez-tools
          - bluetooth
          - openssh-server
          - sudo
          - rsync
          - tmux
          - sshpass
          - fuse
          - libfuse3-dev
          - bzip2
          - libbz2-dev
          - cmake
          - build-essential
          - libattr1-dev
          - zlib1g-dev
        state: present

    # =========================================================================
    # APFS-FUSE Installation (for reading Mac APFS drives - read-only)
    # =========================================================================
    - name: Check if apfs-fuse is already built
      stat:
        path: /opt/apfs-fuse/build/apfs-fuse
      register: apfs_fuse_binary
      changed_when: false

    - name: Create apfs-fuse directory
      file:
        path: /opt/apfs-fuse
        state: directory
        mode: "0755"
      when: not apfs_fuse_binary.stat.exists

    - name: Clone apfs-fuse repository
      git:
        repo: https://github.com/sgan81/apfs-fuse.git
        dest: /opt/apfs-fuse
        version: master
        update: yes
      when: not apfs_fuse_binary.stat.exists

    - name: Initialize and update git submodules
      command:
        cmd: git submodule update --init --recursive
        chdir: /opt/apfs-fuse
      when: not apfs_fuse_binary.stat.exists

    - name: Create build directory
      file:
        path: /opt/apfs-fuse/build
        state: directory
        mode: "0755"
      when: not apfs_fuse_binary.stat.exists

    - name: Build apfs-fuse
      shell: |
        cd /opt/apfs-fuse/build
        cmake ..
        make
      args:
        creates: /opt/apfs-fuse/build/apfs-fuse
      when: not apfs_fuse_binary.stat.exists

    - name: Create symlink for apfs-fuse in PATH
      file:
        src: /opt/apfs-fuse/build/apfs-fuse
        dest: /usr/local/bin/apfs-fuse
        state: link
        mode: "0755"

    # =========================================================================
    # User Configuration
    # =========================================================================
    - name: Check if user {{ target_user }} exists
      getent:
        database: passwd
        key: "{{ target_user }}"
      register: user_check
      failed_when: false
      changed_when: false

    - name: Create user {{ target_user }}
      user:
        name: "{{ target_user }}"
        password: "{{ password_hash }}"
        shell: /bin/bash
        groups: sudo
        append: yes
        create_home: yes
        home: /home/{{ target_user }}
        state: present
      when: user_check.ansible_facts.getent_passwd[target_user] is not defined

    - name: Update password for existing user {{ target_user }} (only if password explicitly provided)
      user:
        name: "{{ target_user }}"
        password: "{{ password_hash }}"
      when:
        - user_check.ansible_facts.getent_passwd[target_user] is defined
        - target_password != "CHANGE_ME"
        - target_password is defined
        - vault_target_password is defined or lookup('env', 'env_target_password') | default('') != ''

    - name: Ensure user {{ target_user }} is in sudo group
      user:
        name: "{{ target_user }}"
        groups: sudo
        append: yes

    - name: Configure passwordless sudo for {{ target_user }}
      lineinfile:
        path: /etc/sudoers.d/{{ target_user }}
        line: "{{ target_user }} ALL=(ALL) NOPASSWD: ALL"
        create: yes
        validate: "visudo -cf %s"
        mode: "0440"
        owner: root
        group: root

    - name: Ensure home directory has correct permissions
      file:
        path: /home/{{ target_user }}
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: "0755"
        state: directory

    # =========================================================================
    # Hostname Configuration
    # =========================================================================
    - name: Set hostname
      hostname:
        name: "{{ hostname }}"

    - name: Update /etc/hosts with hostname
      lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.1\.1.*'
        line: "127.0.1.1 {{ hostname }}"
        state: present

    # =========================================================================
    # Network Configuration (Static IP - Optional, DISABLED BY DEFAULT)
    # =========================================================================
    # WARNING: Static IP configuration is DISABLED by default to prevent network breakage
    # Only enable if you explicitly want static IP and understand the risks
    # To enable: pass -e "configure_static_ip=true" AND -e "static_ip=192.168.2.86"
    - name: Configure static IP (ONLY if explicitly requested)
      block:
        - name: Check if using Netplan (Ubuntu/Debian)
          stat:
            path: /etc/netplan
          register: netplan_dir

        - name: Backup existing netplan config
          copy:
            src: "{{ item }}"
            dest: "{{ item }}.backup-{{ ansible_date_time.epoch }}"
            remote_src: yes
          loop: "{{ netplan_files.files | default([]) | map(attribute='path') | list }}"
          when:
            - netplan_dir.stat.exists
            - netplan_files.files is defined
          failed_when: false
          changed_when: false

        - name: Get existing netplan files
          find:
            paths: /etc/netplan
            patterns: "*.yaml"
          register: netplan_files
          when: netplan_dir.stat.exists
          changed_when: false

        - name: Configure static IP with Netplan (ONLY if explicitly enabled)
          copy:
            dest: /etc/netplan/01-netcfg.yaml
            mode: "0600"
            content: |
              network:
                version: 2
                renderer: networkd
                ethernets:
                  eth0:
                    dhcp4: no
                    addresses:
                      - {{ static_ip }}/24
                    gateway4: {{ static_gateway }}
                    nameservers:
                      addresses: {{ static_dns }}
                  wlan0:
                    dhcp4: yes
                    optional: true
          when:
            - netplan_dir.stat.exists
            - configure_static_ip_var | default(false) | bool
            - static_ip is defined
            - static_ip != ""

        - name: Apply Netplan configuration (ONLY if static IP was configured)
          command: netplan apply
          when:
            - netplan_dir.stat.exists
            - configure_static_ip_var | default(false) | bool
            - static_ip is defined
            - static_ip != ""

      when:
        - configure_static_ip_var | default(false) | bool
        - static_ip is defined
        - static_ip != ""

    - name: Warn if static IP was requested but not configured
      debug:
        msg:
          - "⚠️  Static IP configuration was requested but not applied"
          - "To enable static IP, you must pass: -e 'configure_static_ip=true' -e 'static_ip=192.168.2.86'"
          - "Network will remain on DHCP (safer default, recommended with router reservations)"
      when:
        - static_ip is defined
        - static_ip != ""
        - not (configure_static_ip_var | default(false) | bool)

    # =========================================================================
    # Bluetooth Configuration
    # =========================================================================
    - name: Enable Bluetooth service
      systemd:
        name: bluetooth
        enabled: yes
        state: started

    - name: Check Bluetooth status
      command: systemctl status bluetooth
      register: bluetooth_status
      changed_when: false
      failed_when: false

    - name: Display Bluetooth status
      debug:
        msg: "{{ bluetooth_status.stdout_lines }}"

    # =========================================================================
    # Backup Mount Configuration
    # =========================================================================
    - name: Create backup mount directory
      file:
        path: "{{ backup_mount_path }}"
        state: directory
        mode: "0755"

    - name: Check if backup device exists in fstab
      shell: grep "{{ backup_device_var }}" /etc/fstab || echo "not_found"
      register: fstab_check
      changed_when: false
      failed_when: false
      when: backup_device_var != ""

    - name: Add backup mount to fstab with nofail option (if not exists)
      lineinfile:
        path: /etc/fstab
        line: "{{ backup_device_var }} {{ backup_mount_path }} ext4 defaults,nofail 0 2"
        state: present
        backup: yes
      when:
        - backup_device_var != ""
        - "'not_found' in fstab_check.stdout"

    - name: Update existing fstab entry to include nofail
      replace:
        path: /etc/fstab
        regexp: '^({{ backup_device_var }}[^\s]+)\s+([^\s]+)\s+(ext4)\s+([^,\s]+)(.*?)(\s+\d+\s+\d+)$'
        replace: '\1 \2 \3 \4,nofail\5\6'
        backup: yes
      when:
        - backup_device_var != ""
        - "'not_found' not in fstab_check.stdout"
        - "'nofail' not in fstab_check.stdout"

    # =========================================================================
    # Root Account Configuration (Prevent Lock on Boot Device Switch)
    # =========================================================================
    - name: Ensure root account is unlocked
      command: passwd -u root
      changed_when: false
      failed_when: false

    - name: Set root password if not set
      user:
        name: root
        password: "{{ password_hash }}"
        update_password: always
      when: target_password != "CHANGE_ME" and target_password is defined
      failed_when: false

    - name: Configure PAM to not lock root on boot device changes
      lineinfile:
        path: /etc/pam.d/common-auth
        regexp: '^auth\s+required\s+pam_faillock\.so'
        line: "# auth required pam_faillock.so deny=5 unlock_time=900  # Disabled to prevent root lock on boot device switch"
        backup: yes
      failed_when: false

    - name: Disable root account lockout in faillock
      command: faillock --user root --reset
      changed_when: false
      failed_when: false

    # =========================================================================
    # SSH Configuration
    # =========================================================================
    - name: Ensure SSH service is enabled and started
      systemd:
        name: ssh
        enabled: yes
        state: started

    - name: Configure SSH (optional hardening)
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        backup: yes
      loop:
        - {regexp: "^#?PermitRootLogin", line: "PermitRootLogin no"}
        - {regexp: "^#?PasswordAuthentication", line: "PasswordAuthentication yes"}
        - {regexp: "^#?PubkeyAuthentication", line: "PubkeyAuthentication yes"}
      notify: restart ssh

    # =========================================================================
    # Firewall Configuration
    # =========================================================================
    - name: Ensure UFW is installed
      apt:
        name: ufw
        state: present

    - name: Reset UFW to defaults
      ufw:
        state: reset
      when: false # Disabled by default - enable if needed

    - name: Allow SSH through firewall
      ufw:
        rule: allow
        name: OpenSSH
        state: enabled

    - name: Enable UFW (optional - disabled by default)
      ufw:
        state: enabled
      when: false # Disabled by default - enable if needed

    # =========================================================================
    # System Optimization
    # =========================================================================
    - name: Get cmdline.txt content
      set_fact:
        cmdline_content: "{{ lookup('file', '/boot/firmware/cmdline.txt', errors='ignore') | default('') | string }}"
      changed_when: false
      failed_when: false

    - name: Configure cgroups for containers
      lineinfile:
        path: /boot/firmware/cmdline.txt
        regexp: "cgroup_memory=1 cgroup_enable=memory"
        line: " cgroup_memory=1 cgroup_enable=memory"
        backrefs: yes
        state: present
      when: cmdline_content is defined and 'cgroup_memory=1' not in cmdline_content

    - name: Set timezone
      timezone:
        name: America/Toronto

    - name: Configure NTP
      systemd:
        name: systemd-timesyncd
        enabled: yes
        state: started

    # =========================================================================
    # Summary
    # =========================================================================
    - name: Display configuration summary
      debug:
        msg:
          - "=== System Configuration Complete ==="
          - "Hostname: {{ hostname }}"
          - "User: {{ target_user }}"
          - "Password: [REDACTED]"
          - "Static IP: {{ static_ip if static_ip else 'DHCP' }}"
          - "Bluetooth: Enabled"
          - "Backup mount: {{ backup_mount_path }} (nofail configured)"
          - ""
          - "Next steps:"
          - "1. Install k3s: ansible-playbook playbooks/install-k3s.yml --ask-pass --ask-become-pass"
          - "2. Bootstrap FluxCD GitOps: ansible-playbook playbooks/bootstrap-flux.yml -e bootstrap_flux=true"
          - "3. Deploy applications"

  handlers:
    - name: restart ssh
      systemd:
        name: sshd
        state: restarted

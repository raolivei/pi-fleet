---
# Master orchestration playbook for complete cluster setup
# Runs all playbooks in the correct order to get cluster fully operational
#
# Usage:
#   ansible-playbook playbooks/setup-cluster.yml
#   ansible-playbook playbooks/setup-cluster.yml -e bootstrap_flux_var=true
#
# Note: For a 3-node HA cluster with nodes at:
#   - node-1: 192.168.2.101 (WiFi) / 10.0.0.1 (Gigabit)
#   - node-2: 192.168.2.102 (WiFi) / 10.0.0.2 (Gigabit)
#   - node-3: 192.168.2.103 (WiFi) / 10.0.0.3 (Gigabit)
#   - kube-vip VIP: 192.168.2.100

- name: Configure DNS (so hostnames resolve)
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    node_1_ip: "192.168.2.101"
    node_2_ip: "192.168.2.102"
    node_3_ip: "192.168.2.103"
    kube_vip_ip: "192.168.2.100"
  tasks:
    - name: Check if hostnames resolve
      shell: |
        getent hosts node-1.eldertree.local node-2.eldertree.local node-3.eldertree.local 2>/dev/null || echo "not_resolved"
      register: dns_resolve_check
      changed_when: false
      failed_when: false

    - name: Configure DNS if not resolved
      become: true
      shell: |
        # Add cluster nodes to /etc/hosts if not present
        grep -q "node-1.eldertree.local" /etc/hosts || echo "{{ node_1_ip }}  node-1.eldertree.local node-1" >> /etc/hosts
        grep -q "node-2.eldertree.local" /etc/hosts || echo "{{ node_2_ip }}  node-2.eldertree.local node-2" >> /etc/hosts
        grep -q "node-3.eldertree.local" /etc/hosts || echo "{{ node_3_ip }}  node-3.eldertree.local node-3" >> /etc/hosts
        grep -q "eldertree.local" /etc/hosts || echo "{{ kube_vip_ip }}  eldertree.local eldertree" >> /etc/hosts
      register: dns_setup
      changed_when: "'not_resolved' in dns_resolve_check.stdout"
      failed_when: false
      when: "'not_resolved' in dns_resolve_check.stdout"
      ignore_errors: true

    - name: Display DNS status
      debug:
        msg:
          - "DNS: {{ '✅ Configured' if 'not_resolved' not in dns_resolve_check.stdout else '⚠️  Manual setup may be required' }}"
          - "Nodes: node-1 ({{ node_1_ip }}), node-2 ({{ node_2_ip }}), node-3 ({{ node_3_ip }})"
          - "VIP: {{ kube_vip_ip }}"

- name: System Setup on All Nodes
  import_playbook: setup-system.yml
  vars:
    target_user: raolivei

- name: Terminal Monitoring on All Nodes
  import_playbook: setup-terminal-monitoring.yml
  vars:
    target_user: raolivei

- name: Install k3s Control Plane (node-1 - cluster init)
  import_playbook: install-k3s.yml
  vars:
    k3s_hostname: "node-1.eldertree.local"
    kubeconfig_path: "~/.kube/config-eldertree"
  when: inventory_hostname == "node-1"

- name: Get k3s token from control plane
  hosts: node-1
  tasks:
    - name: Get k3s node token
      slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: k3s_token_content
      changed_when: false
      failed_when: false

    - name: Set k3s token fact for all hosts
      set_fact:
        k3s_node_token: "{{ k3s_token_content.content | b64decode }}"
      changed_when: false
      delegate_to: localhost
      connection: local
      become: false
      delegate_facts: true

- name: Join node-2 to cluster (HA server)
  import_playbook: install-k3s.yml
  vars:
    k3s_hostname: "node-2.eldertree.local"
    k3s_server_url: "https://192.168.2.100:6443"  # Use VIP
    k3s_token: "{{ hostvars['localhost']['k3s_node_token'] | default('') }}"
  when: inventory_hostname == "node-2"

- name: Join node-3 to cluster (HA server)
  import_playbook: install-k3s.yml
  vars:
    k3s_hostname: "node-3.eldertree.local"
    k3s_server_url: "https://192.168.2.100:6443"  # Use VIP
    k3s_token: "{{ hostvars['localhost']['k3s_node_token'] | default('') }}"
  when: inventory_hostname == "node-3"

- name: Bootstrap FluxCD (optional)
  import_playbook: bootstrap-flux.yml
  vars:
    kubeconfig_path: "~/.kube/config-eldertree"
  when: bootstrap_flux_var | default(false) | bool

- name: Cluster Setup Summary
  hosts: localhost
  connection: local
  become: false
  tasks:
    - name: Check kubeconfig exists
      stat:
        path: "~/.kube/config-eldertree"
      register: kubeconfig_check
      changed_when: false

    - name: Display completion summary
      debug:
        msg:
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - "✅ Cluster Setup Complete!"
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - ""
          - "Nodes configured:"
          - "  - node-1: 192.168.2.101 (WiFi) / 10.0.0.1 (Gigabit)"
          - "  - node-2: 192.168.2.102 (WiFi) / 10.0.0.2 (Gigabit)"
          - "  - node-3: 192.168.2.103 (WiFi) / 10.0.0.3 (Gigabit)"
          - "  - kube-vip VIP: 192.168.2.100"
          - ""
          - "System Setup: ✅ Complete on all nodes"
          - "k3s HA Cluster: ✅ 3-node control plane"
          - "FluxCD: {{ '✅ Bootstrapped' if bootstrap_flux_var | default(false) | bool else '⏭️  Skipped (run with -e bootstrap_flux_var=true)' }}"
          - ""
          - "Next steps:"
          - "  1. Verify cluster: kubectl get nodes --kubeconfig=~/.kube/config-eldertree"
          - "  2. Check pods: kubectl get pods -A --kubeconfig=~/.kube/config-eldertree"
          - ""
          - "Access nodes:"
          - "  ssh raolivei@node-1  # or 192.168.2.101"
          - "  ssh raolivei@node-2  # or 192.168.2.102"
          - "  ssh raolivei@node-3  # or 192.168.2.103"
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

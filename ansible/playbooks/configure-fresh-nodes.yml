---
# Configure fresh Raspberry Pi installations
# - Set hostnames
# - Configure PoE+ HAT
# - Prepare for NVMe boot migration

- name: Configure Fresh Node Installations
  hosts: raspberry_pi
  become: yes
  vars:
    poe_fan_temp0: 50000
    poe_fan_temp1: 60000
    poe_fan_temp2: 70000
    poe_fan_temp3: 80000

  tasks:
    - name: Set hostname
      hostname:
        name: "{{ inventory_hostname_short }}"
      notify: restart hostname

    - name: Update /etc/hosts
      lineinfile:
        path: /etc/hosts
        regexp: "^{{ ansible_default_ipv4.address }}.*"
        line: "{{ ansible_default_ipv4.address }}\t{{ inventory_hostname_short }} {{ inventory_hostname }}"
        state: present

    - name: Check if PoE+ HAT is present
      stat:
        path: /proc/device-tree/hat/product
      register: poe_hat_check

    - name: Configure PoE+ HAT in config.txt
      blockinfile:
        path: "{{ item }}"
        marker: "# {mark} ANSIBLE MANAGED BLOCK - PoE+ HAT Configuration"
        block: |
          # PoE+ HAT Configuration
          dtparam=poe_fan_temp0={{ poe_fan_temp0 }}
          dtparam=poe_fan_temp1={{ poe_fan_temp1 }}
          dtparam=poe_fan_temp2={{ poe_fan_temp2 }}
          dtparam=poe_fan_temp3={{ poe_fan_temp3 }}
        create: yes
      loop:
        - /boot/firmware/config.txt
        - /boot/config.txt
      when: poe_hat_check.stat.exists or poe_hat_check.stat.exists == false
      # Configure anyway - will work when HAT is connected

    - name: Check NVMe device
      command: test -b /dev/nvme0n1
      register: nvme_check
      changed_when: false
      failed_when: false

    - name: Get NVMe size
      command: blockdev --getsize64 /dev/nvme0n1
      register: nvme_size
      when: nvme_check.rc == 0
      changed_when: false

    - name: Display NVMe status
      debug:
        msg: "NVMe detected: {{ (nvme_size.stdout | int) / 1024 / 1024 / 1024 }}GB"
      when: nvme_check.rc == 0

    - name: Warn if NVMe not detected
      debug:
        msg: "WARNING: NVMe not detected. Please verify HAT and NVMe are properly connected."
      when: nvme_check.rc != 0

  handlers:
    - name: restart hostname
      systemd:
        name: systemd-hostnamed
        state: restarted


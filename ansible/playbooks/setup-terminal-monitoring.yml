---
- name: Setup Terminal Monitoring Tools for Eldertree
  hosts: raspberry_pi
  become: true
  vars:
    target_user: raolivei
    # Password should be set via Ansible Vault or environment variable
    # Use: ansible-playbook --ask-vault-pass or set env_target_password environment variable
    target_password: "{{ vault_target_password | default(lookup('env', 'env_target_password') | default('CHANGE_ME')) }}"

  tasks:
    # =========================================================================
    # Install Monitoring Tools
    # =========================================================================
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install btop and tmux
      apt:
        name:
          - btop
          - tmux
        state: present

    - name: Try to install neofetch (optional)
      apt:
        name: neofetch
        state: present
      ignore_errors: true
      register: neofetch_result

    - name: Install neofetch from source if apt package unavailable
      block:
        - name: Install dependencies for neofetch
          apt:
            name:
              - git
              - bash
            state: present

        - name: Clone neofetch repository
          git:
            repo: https://github.com/dylanaraps/neofetch.git
            dest: /tmp/neofetch
            version: master

        - name: Install neofetch
          copy:
            src: /tmp/neofetch/neofetch
            dest: /usr/local/bin/neofetch
            mode: "0755"
            remote_src: yes

        - name: Create neofetch config directory
          file:
            path: /home/{{ target_user }}/.config/neofetch
            state: directory
            owner: "{{ target_user }}"
            group: "{{ target_user }}"
            mode: "0755"

        - name: Clean up neofetch source
          file:
            path: /tmp/neofetch
            state: absent
      when: neofetch_result.failed | default(false)

    # =========================================================================
    # Create System Info Display Script
    # =========================================================================
    - name: Create system info script
      copy:
        dest: /home/{{ target_user }}/.system-info.sh
        content: |
          #!/bin/bash
          # System info display for Raspberry Pi
          # Shows key metrics on login

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ–¥ï¸  ELDERTREE - Raspberry Pi System Status"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Hostname and uptime
          echo "Hostname: $(hostname)"
          echo "Uptime: $(uptime -p)"
          echo ""

          # CPU Temperature
          if command -v vcgencmd &> /dev/null; then
              TEMP=$(vcgencmd measure_temp | cut -d= -f2)
              echo "ðŸŒ¡ï¸  CPU Temperature: $TEMP"
          else
              if [ -f /sys/class/thermal/thermal_zone0/temp ]; then
                  TEMP=$(cat /sys/class/thermal/thermal_zone0/temp)
                  TEMP=$((TEMP / 1000))
                  echo "ðŸŒ¡ï¸  CPU Temperature: ${TEMP}Â°C"
              fi
          fi

          # CPU Load
          echo "âš¡ CPU Load: $(uptime | awk -F'load average:' '{print $2}')"

          # Memory
          MEM_TOTAL=$(free -h | awk '/^Mem:/ {print $2}')
          MEM_USED=$(free -h | awk '/^Mem:/ {print $3}')
          MEM_PERCENT=$(free | awk '/^Mem:/ {printf "%.1f", $3/$2 * 100}')
          echo "ðŸ’¾ Memory: $MEM_USED / $MEM_TOTAL (${MEM_PERCENT}% used)"

          # Disk Usage
          DISK_USED=$(df -h / | awk 'NR==2 {print $3}')
          DISK_TOTAL=$(df -h / | awk 'NR==2 {print $2}')
          DISK_PERCENT=$(df / | awk 'NR==2 {print $5}')
          echo "ðŸ’¿ Disk: $DISK_USED / $DISK_TOTAL ($DISK_PERCENT used)"

          # Network IP
          IP=$(hostname -I | awk '{print $1}')
          echo "ðŸŒ IP Address: $IP"

          # Kubernetes status (if available)
          if command -v kubectl &> /dev/null && kubectl cluster-info &> /dev/null 2>&1; then
              NODES=$(kubectl get nodes --no-headers 2>/dev/null | wc -l)
              PODS=$(kubectl get pods --all-namespaces --no-headers 2>/dev/null | wc -l)
              echo "â˜¸ï¸  Kubernetes: $NODES node(s), $PODS pod(s)"
          fi

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ’¡ Run 'btop' for interactive monitoring"
          if command -v neofetch &> /dev/null; then
              echo "ðŸ’¡ Run 'neofetch' for system info with ASCII art"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        mode: "0755"
        owner: "{{ target_user }}"
        group: "{{ target_user }}"

    # =========================================================================
    # Configure .bashrc to Show System Info and Auto-Start btop on Login
    # =========================================================================
    - name: Add system info display and auto-start btop to bashrc
      blockinfile:
        path: /home/{{ target_user }}/.bashrc
        marker: "# {mark} ANSIBLE MANAGED BLOCK - Terminal Monitoring"
        block: |
          # Show system info and auto-start real-time monitor on login (only for interactive shells)
          if [ -t 0 ]; then
              # Quick system status banner
              ~/.system-info.sh
              echo ""
              echo "Starting real-time monitor (btop)..."
              echo "Press 'q' to quit and return to shell"
              sleep 2
              # Auto-start btop for real-time monitoring
              btop
          fi
        owner: "{{ target_user }}"
        group: "{{ target_user }}"

    # =========================================================================
    # Configure btop (Optional - create config directory)
    # =========================================================================
    - name: Create btop config directory
      file:
        path: /home/{{ target_user }}/.config/btop
        state: directory
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: "0755"

    # =========================================================================
    # Fix SSH Terminal Environment for btop
    # =========================================================================
    - name: Create .local/bin directory
      file:
        path: /home/{{ target_user }}/.local/bin
        state: directory
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: "0755"

    - name: Create btop wrapper script to handle SSH terminal issues
      copy:
        dest: /home/{{ target_user }}/.local/bin/btop
        content: |
          #!/bin/bash
          # Wrapper script for btop to fix SSH terminal issues
          # Ensures proper TERM and terminal size detection

          # Set TERM if not set or if it's a basic type
          if [ -z "$TERM" ] || [ "$TERM" = "dumb" ] || [ "$TERM" = "unknown" ]; then
              # Try to detect best terminal type
              if [ -n "$SSH_CONNECTION" ]; then
                  # Over SSH, prefer xterm-256color or screen-256color
                  if [ -n "$TMUX" ]; then
                      export TERM="screen-256color"
                  else
                      export TERM="xterm-256color"
                  fi
              else
                  export TERM="xterm-256color"
              fi
          fi

          # Ensure we have a TTY
          if [ ! -t 0 ]; then
              echo "Error: btop requires an interactive terminal (TTY)"
              echo "Make sure you're running this over SSH with a proper terminal"
              exit 1
          fi

          # Check terminal size
          if [ -z "$COLUMNS" ] || [ -z "$LINES" ]; then
              # Try to get terminal size
              if command -v stty >/dev/null 2>&1; then
                  export COLUMNS=$(stty size 2>/dev/null | awk '{print $2}')
                  export LINES=$(stty size 2>/dev/null | awk '{print $1}')
              fi
          fi

          # Run btop with proper environment
          /usr/bin/btop "$@"
        mode: "0755"
        owner: "{{ target_user }}"
        group: "{{ target_user }}"

    - name: Ensure .local/bin is in PATH
      lineinfile:
        path: /home/{{ target_user }}/.bashrc
        regexp: '^export PATH=.*\.local/bin'
        line: 'export PATH="$HOME/.local/bin:$PATH"'
        state: present
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
      check_mode: false

    - name: Add TERM configuration to bashrc for SSH sessions
      blockinfile:
        path: /home/{{ target_user }}/.bashrc
        marker: "# {mark} ANSIBLE MANAGED BLOCK - Terminal Environment"
        block: |
          # Fix TERM for SSH sessions (required for btop and other terminal apps)
          if [ -n "$SSH_CONNECTION" ]; then
              # Over SSH, ensure we have a proper TERM
              if [ -z "$TERM" ] || [ "$TERM" = "dumb" ] || [ "$TERM" = "unknown" ]; then
                  if [ -n "$TMUX" ]; then
                      export TERM="screen-256color"
                  else
                      export TERM="xterm-256color"
                  fi
              fi
          fi
        owner: "{{ target_user }}"
        group: "{{ target_user }}"

    # =========================================================================
    # Summary
    # =========================================================================
    - name: Check if neofetch is installed
      command: which neofetch
      register: neofetch_check
      changed_when: false
      failed_when: false

    - name: Display configuration summary
      debug:
        msg:
          - "=== Terminal Monitoring Setup Complete ==="
          - "Installed: btop, tmux"
          - "Neofetch: {{ 'Installed' if neofetch_check.rc == 0 else 'Not available' }}"
          - "System info script: ~/.system-info.sh"
          - "Login banner + auto-start btop: Configured in ~/.bashrc"
          - "SSH terminal fixes: TERM environment configured, btop wrapper script created"
          - ""
          - "Usage:"
          - "  - Real-time monitor (btop) will auto-start on login"
          - "  - Press 'q' in btop to quit and return to shell"
          - "  - Run 'btop' manually anytime for monitoring"
          - "  - The btop wrapper (~/.local/bin/btop) fixes SSH terminal issues"
          - "  - Run 'neofetch' for system info with ASCII art (if installed)"
          - "  - Run 'htop' for classic process monitor (already installed)"
          - ""
          - "Troubleshooting:"
          - "  - If btop still fails over SSH, ensure your SSH client sends TERM"
          - "  - Try: export TERM=xterm-256color before running btop"
          - "  - The wrapper script automatically fixes TERM if needed"

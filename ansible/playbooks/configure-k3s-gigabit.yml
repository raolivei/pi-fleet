---
# Configure k3s to use gigabit network for node-to-node communication
#
# This playbook configures /etc/rancher/k3s/config.yaml with:
# - node-ip: gigabit IP (10.0.0.X)
# - bind-address: 0.0.0.0 (for kube-vip VIP access)
# - advertise-address: gigabit IP
# - tls-san: all valid hostnames/IPs
#
# Usage:
#   ansible-playbook playbooks/configure-k3s-gigabit.yml
#
# To apply to a single node:
#   ansible-playbook playbooks/configure-k3s-gigabit.yml --limit node-1
#
# Note: This playbook uses config.yaml instead of modifying the service file
#       for cleaner configuration management.

- name: Configure k3s to use gigabit network
  hosts: raspberry_pi
  become: true
  gather_facts: true

  vars:
    # Import from group_vars/all.yml
    gigabit_interface: "{{ k3s_flannel_iface | default('eth0') }}"

    # Node-specific configuration mapping
    node_config:
      node-1:
        node_ip: "{{ node_1_eth0_ip }}"
        wifi_ip: "{{ node_1_ip }}"
        hostname: "node-1.eldertree.local"
      node-2:
        node_ip: "{{ node_2_eth0_ip }}"
        wifi_ip: "{{ node_2_ip }}"
        hostname: "node-2.eldertree.local"
      node-3:
        node_ip: "{{ node_3_eth0_ip }}"
        wifi_ip: "{{ node_3_ip }}"
        hostname: "node-3.eldertree.local"

  tasks:
    # =========================================================================
    # Determine node configuration
    # =========================================================================
    - name: Set node-specific variables
      set_fact:
        this_node_config: "{{ node_config[inventory_hostname] }}"
      failed_when: this_node_config is not defined

    - name: Display configuration to be applied
      debug:
        msg:
          - "Node: {{ inventory_hostname }}"
          - "Gigabit IP (node-ip): {{ this_node_config.node_ip }}"
          - "WiFi IP: {{ this_node_config.wifi_ip }}"
          - "Hostname: {{ this_node_config.hostname }}"
          - "VIP: {{ kube_vip_ip }}"
          - "bind-address: {{ k3s_bind_address | default('0.0.0.0') }}"
          - "Flannel interface: {{ gigabit_interface }}"

    # =========================================================================
    # Verify eth0 has gigabit IP configured
    # =========================================================================
    - name: Check if eth0 has gigabit IP
      shell: ip addr show eth0 | grep "inet {{ this_node_config.node_ip }}/" || echo "not_configured"
      register: eth0_ip_check
      changed_when: false
      failed_when: false

    - name: Fail if eth0 gigabit IP is not configured
      fail:
        msg: "eth0 does not have gigabit IP {{ this_node_config.node_ip }} configured. Please run setup-system.yml playbook first to configure the gigabit network."
      when: "'not_configured' in eth0_ip_check.stdout"

    # =========================================================================
    # Check if k3s is installed
    # =========================================================================
    - name: Check if k3s service exists (control plane)
      stat:
        path: /etc/systemd/system/k3s.service
      register: k3s_service_file
      changed_when: false

    - name: Check if k3s-agent service exists (worker)
      stat:
        path: /etc/systemd/system/k3s-agent.service
      register: k3s_agent_service_file
      changed_when: false

    - name: Determine service type
      set_fact:
        is_control_plane: "{{ k3s_service_file.stat.exists | default(false) }}"
        is_worker: "{{ k3s_agent_service_file.stat.exists | default(false) }}"

    - name: Fail if k3s is not installed
      fail:
        msg: "k3s is not installed. Please install k3s first."
      when: not is_control_plane and not is_worker

    # =========================================================================
    # Backup existing config
    # =========================================================================
    - name: Check if config.yaml exists
      stat:
        path: /etc/rancher/k3s/config.yaml
      register: existing_config

    - name: Backup existing config.yaml
      copy:
        src: /etc/rancher/k3s/config.yaml
        dest: "/etc/rancher/k3s/config.yaml.backup-{{ ansible_date_time.epoch }}"
        remote_src: yes
        mode: "0600"
      when: existing_config.stat.exists | default(false)

    # =========================================================================
    # Get cluster token from init node for joining nodes
    # =========================================================================
    - name: Get cluster token from init node
      shell: cat /var/lib/rancher/k3s/server/node-token
      register: cluster_token_result
      delegate_to: "{{ k3s_cluster_init_node }}"
      run_once: true
      changed_when: false
      when: is_control_plane

    - name: Set cluster token fact
      set_fact:
        k3s_cluster_token: "{{ cluster_token_result.stdout }}"
      when: is_control_plane and cluster_token_result.stdout is defined

    # =========================================================================
    # Create k3s config.yaml (control plane)
    # =========================================================================
    - name: Ensure /etc/rancher/k3s directory exists
      file:
        path: /etc/rancher/k3s
        state: directory
        mode: "0755"

    - name: Write k3s config.yaml (control plane - init node)
      copy:
        content: |
          # k3s configuration - managed by Ansible
          # Playbook: configure-k3s-gigabit.yml
          # Last updated: {{ ansible_date_time.iso8601 }}
          # Node: {{ inventory_hostname }} (cluster init node)

          # Node identity - use gigabit IP for internal communication
          node-ip: {{ this_node_config.node_ip }}

          # API server binding
          # IMPORTANT: bind-address must be 0.0.0.0 for kube-vip to work!
          bind-address: {{ k3s_bind_address | default('0.0.0.0') }}

          # Advertise the gigabit IP for internal cluster communication
          advertise-address: {{ this_node_config.node_ip }}

          # Flannel interface for CNI
          flannel-iface: {{ gigabit_interface }}

          # TLS SANs - all valid ways to reach this API server
          tls-san:
            - {{ kube_vip_ip }}
            - {{ this_node_config.wifi_ip }}
            - {{ this_node_config.node_ip }}
            - {{ this_node_config.hostname }}
            - {{ inventory_hostname }}
        dest: /etc/rancher/k3s/config.yaml
        mode: "0600"
        owner: root
        group: root
      register: config_updated
      when:
        - is_control_plane
        - inventory_hostname == k3s_cluster_init_node

    - name: Write k3s config.yaml (control plane - joining nodes)
      copy:
        content: |
          # k3s configuration - managed by Ansible
          # Playbook: configure-k3s-gigabit.yml
          # Last updated: {{ ansible_date_time.iso8601 }}
          # Node: {{ inventory_hostname }} (joining node)

          # Cluster join configuration - required for auto-rejoin after reboot
          server: https://{{ node_1_eth0_ip }}:6443
          token: {{ k3s_cluster_token }}

          # Node identity - use gigabit IP for internal communication
          node-ip: {{ this_node_config.node_ip }}

          # API server binding
          # IMPORTANT: bind-address must be 0.0.0.0 for kube-vip to work!
          bind-address: {{ k3s_bind_address | default('0.0.0.0') }}

          # Advertise the gigabit IP for internal cluster communication
          advertise-address: {{ this_node_config.node_ip }}

          # Flannel interface for CNI
          flannel-iface: {{ gigabit_interface }}

          # TLS SANs - all valid ways to reach this API server
          tls-san:
            - {{ kube_vip_ip }}
            - {{ this_node_config.wifi_ip }}
            - {{ this_node_config.node_ip }}
            - {{ this_node_config.hostname }}
            - {{ inventory_hostname }}
        dest: /etc/rancher/k3s/config.yaml
        mode: "0600"
        owner: root
        group: root
      register: config_updated_joining
      when:
        - is_control_plane
        - inventory_hostname != k3s_cluster_init_node
        - k3s_cluster_token is defined

    # =========================================================================
    # Create k3s config.yaml (worker/agent)
    # =========================================================================
    - name: Write k3s config.yaml (worker)
      copy:
        content: |
          # k3s agent configuration - managed by Ansible
          # Playbook: configure-k3s-gigabit.yml
          # Last updated: {{ ansible_date_time.iso8601 }}

          # Node identity - use gigabit IP for internal communication
          node-ip: {{ this_node_config.node_ip }}
        dest: /etc/rancher/k3s/config.yaml
        mode: "0600"
        owner: root
        group: root
      register: agent_config_updated
      when: is_worker

    # =========================================================================
    # Restart k3s services
    # =========================================================================
    - name: Restart k3s service (control plane)
      systemd:
        name: k3s
        state: restarted
        daemon_reload: yes
      when:
        - is_control_plane
        - config_updated.changed | default(false) or config_updated_joining.changed | default(false)

    - name: Restart k3s-agent service (worker)
      systemd:
        name: k3s-agent
        state: restarted
        daemon_reload: yes
      when:
        - is_worker
        - agent_config_updated.changed | default(false)

    - name: Wait for k3s to be ready
      command: k3s kubectl get nodes
      register: k3s_ready
      until: k3s_ready.rc == 0
      retries: 30
      delay: 5
      changed_when: false
      failed_when: false
      when: is_control_plane

    # =========================================================================
    # Verify configuration
    # =========================================================================
    - name: Verify API server is listening on all interfaces
      shell: ss -tlnp | grep 6443 | head -1
      register: api_server_listen
      changed_when: false
      failed_when: false
      when: is_control_plane

    - name: Display API server listening status
      debug:
        msg: "API server listening: {{ api_server_listen.stdout }}"
      when:
        - is_control_plane
        - api_server_listen.stdout is defined

    - name: Display k3s nodes with new IPs
      command: k3s kubectl get nodes -o wide
      register: k3s_nodes
      changed_when: false
      failed_when: false
      when: is_control_plane

    - name: Show k3s nodes
      debug:
        var: k3s_nodes.stdout_lines
      when: is_control_plane and k3s_nodes.rc == 0

    - name: Display completion message
      debug:
        msg:
          - "âœ… k3s configured to use gigabit network"
          - ""
          - "Configuration applied:"
          - "  node-ip: {{ this_node_config.node_ip }}"
          - "  bind-address: {{ k3s_bind_address | default('0.0.0.0') }}"
          - "  advertise-address: {{ this_node_config.node_ip }}"
          - "  Interface: {{ gigabit_interface }}"
          - ""
          - "Verify with: kubectl get nodes -o wide"
